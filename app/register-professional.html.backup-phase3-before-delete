<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Registration - Claim Navigator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .register-container {
      background: white;
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
      text-align: center;
      color: #1e40af;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }
    label {
      font-weight: 600;
      font-size: 0.9rem;
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    button {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.75rem;
      background: #1e40af;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #3b82f6;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .alt {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.9rem;
    }
    .alt a {
      color: #1e40af;
      text-decoration: none;
    }
    .alt a:hover {
      text-decoration: underline;
    }
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #fecaca;
      margin: 1rem 0;
      display: none;
    }
    .success {
      background: #f0fdf4;
      color: #166534;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #bbf7d0;
      margin: 1rem 0;
      display: none;
    }
    .loading {
      text-align: center;
      color: #6b7280;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="register-container">
    <h1>Professional Registration</h1>
    <p class="subtitle">Join the Claim Navigator Professional Lead Exchange</p>
    
    <div id="error-message" class="error"></div>
    <div id="success-message" class="success"></div>
    <div id="loading-message" class="loading" style="display: none;">Registering...</div>
    
    <form id="register-form">
      <label>Company Name (Optional)</label>
      <input type="text" id="company_name" placeholder="Your company name" />
      
      <label>Specialty</label>
      <select id="specialty" required>
        <option value="">Select your specialty</option>
        <option value="public_adjuster">Public Adjuster</option>
        <option value="attorney">Attorney</option>
        <option value="contractor">Contractor</option>
        <option value="consultant">Insurance Consultant</option>
        <option value="other">Other</option>
      </select>
      
      <label>State</label>
      <select id="state" required>
        <option value="">Select your state</option>
        <option value="AL">Alabama</option>
        <option value="AK">Alaska</option>
        <option value="AZ">Arizona</option>
        <option value="AR">Arkansas</option>
        <option value="CA">California</option>
        <option value="CO">Colorado</option>
        <option value="CT">Connecticut</option>
        <option value="DE">Delaware</option>
        <option value="FL">Florida</option>
        <option value="GA">Georgia</option>
        <option value="HI">Hawaii</option>
        <option value="ID">Idaho</option>
        <option value="IL">Illinois</option>
        <option value="IN">Indiana</option>
        <option value="IA">Iowa</option>
        <option value="KS">Kansas</option>
        <option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option>
        <option value="ME">Maine</option>
        <option value="MD">Maryland</option>
        <option value="MA">Massachusetts</option>
        <option value="MI">Michigan</option>
        <option value="MN">Minnesota</option>
        <option value="MS">Mississippi</option>
        <option value="MO">Missouri</option>
        <option value="MT">Montana</option>
        <option value="NE">Nebraska</option>
        <option value="NV">Nevada</option>
        <option value="NH">New Hampshire</option>
        <option value="NJ">New Jersey</option>
        <option value="NM">New Mexico</option>
        <option value="NY">New York</option>
        <option value="NC">North Carolina</option>
        <option value="ND">North Dakota</option>
        <option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option>
        <option value="OR">Oregon</option>
        <option value="PA">Pennsylvania</option>
        <option value="RI">Rhode Island</option>
        <option value="SC">South Carolina</option>
        <option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option>
        <option value="TX">Texas</option>
        <option value="UT">Utah</option>
        <option value="VT">Vermont</option>
        <option value="VA">Virginia</option>
        <option value="WA">Washington</option>
        <option value="WV">West Virginia</option>
        <option value="WI">Wisconsin</option>
        <option value="WY">Wyoming</option>
      </select>
      
      <button type="submit">Register as Professional</button>
    </form>
    
    <div class="alt">
      <p>Already have an account? <a href="login.html">Login</a></p>
      <p><a href="/">‚Üê Back to Home</a></p>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Initialize Supabase client
    const supabase = createClient(
      "{{ SUPABASE_URL }}",
      "{{ SUPABASE_ANON_KEY }}"
    );

    const form = document.getElementById('register-form');
    const errorEl = document.getElementById('error-message');
    const successEl = document.getElementById('success-message');
    const loadingEl = document.getElementById('loading-message');

    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      
      if (error || !user) {
        // User not logged in, redirect to login
        window.location.href = 'login.html';
        return;
      }

      // Check if user is already a professional
      const { data: professional, error: profError } = await supabase
        .from('professionals')
        .select('*')
        .eq('id', user.id)
        .single();

      if (professional) {
        // User is already a professional, redirect to dashboard
        window.location.href = 'professional-dashboard.html';
        return;
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const companyName = document.getElementById('company_name').value;
      const specialty = document.getElementById('specialty').value;
      const state = document.getElementById('state').value;

      if (!specialty || !state) {
        showError('Please fill in all required fields.');
        return;
      }

      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError || !user) {
          showError('You must be logged in to register as a professional.');
          return;
        }

        showLoading();

        // Register as professional
        const response = await fetch('/.netlify/functions/register-professional', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`
          },
          body: JSON.stringify({
            user_id: user.id,
            company_name: companyName,
            specialty: specialty,
            state: state,
            email: user.email
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Registration failed');
        }

        hideLoading();
        showSuccess('Registration successful! Redirecting to your dashboard...');
        
        // Redirect to professional dashboard after a short delay
        setTimeout(() => {
          window.location.href = 'professional-dashboard.html';
        }, 2000);

      } catch (error) {
        hideLoading();
        showError('Registration failed: ' + error.message);
      }
    });

    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    }

    function showSuccess(message) {
      successEl.textContent = message;
      successEl.style.display = 'block';
      errorEl.style.display = 'none';
    }

    function showLoading() {
      loadingEl.style.display = 'block';
      form.style.display = 'none';
    }

    function hideLoading() {
      loadingEl.style.display = 'none';
      form.style.display = 'block';
    }
  </script>
<script type="module" src="/app/assets/js/diagnostics.js"></script>
<script type="module" src="/app/assets/js/window-bridge.js"></script>
</body>
</html>
