<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activation Checklist - Claim Navigator</title>
  <link rel="stylesheet" href="/app/assets/css/resource-center.css">
  
    <script src="/assets/js/navigation-template.js"></script>
  <link rel="stylesheet" href="/app/assets/css/tool-visual-alignment.css">
</head>
<body>
    <script>createNavigationBar();</script>

  <div class="activation-container">
    <div class="activation-header">
      <h1>Claim Activation Checklist</h1>
      <p>Complete these steps to fully activate your claim and unlock all features</p>
    </div>
    
    <div id="progress-summary" class="progress-summary">
      <h3>Activation Progress</h3>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <p id="progress-text" style="color: #9ca3af; margin: 0;">0% complete</p>
    </div>
    
    <div class="activation-card">
      <h2>Essential Steps</h2>
      <div id="checklist-items">
        <!-- Checklist items will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <script src="/app/assets/js/supabase-client.js"></script>
  <script src="/app/assets/js/auth-session.js"></script>
  <script src="/app/assets/js/claim-profile.js"></script>
  <script src="/app/assets/js/claim-health-v2.js"></script>
  <script src="/app/assets/js/toasts.js"></script>
  <script src="/app/assets/js/loading.js"></script>
  <script>
    (async () => {
      // Require authentication
      const isAuthenticated = await window.CNAuth?.requireAuth(true);
      if (!isAuthenticated) return;

      try {
        const user = await window.CNAuth.currentUser();
        if (!user) return;

        const supabase = await window.getSupabaseClient();
        const { data: claims } = await supabase
          .from('claims')
          .select('*')
          .eq('user_id', user.id)
          .eq('status', 'active')
          .limit(1);

        const activeClaim = claims && claims.length > 0 ? claims[0] : null;
        if (!activeClaim) {
          window.location.href = '/app/dashboard.html';
          return;
        }

        const profile = window.CNClaimProfile?.getClaimProfile() || {};
        const health = window.CNHealth ? window.CNHealth.compute() : { score: 0 };
        
        // Get evidence and document counts
        let photoCount = 0;
        let docCount = 0;
        if (window.CNStorage) {
          const evidenceData = window.CNStorage.getSection("evidence") || { count: 0 };
          const docData = window.CNStorage.getSection("documents") || { count: 0 };
          photoCount = evidenceData.count || 0;
          docCount = docData.count || 0;
        } else {
          photoCount = parseInt(localStorage.getItem("cn_evidence_photo_count") || "0", 10);
          docCount = parseInt(localStorage.getItem("cn_docs_generated") || "0", 10);
        }

        // Check roadmap stage 1 completion
        const roadmapState = JSON.parse(localStorage.getItem("claimRoadmapProgress") || "{}");
        const stage1Complete = roadmapState.completedStageIds?.includes(1) || false;

        // Check AI agent usage
        const activation = activeClaim.claim_data?.activation || {};
        const aiAgentUsed = activation.aiAgentUsed || false;

        // Define checklist items
        const checklistItems = [
          {
            id: 'lossDate',
            label: 'Add Loss Date',
            description: 'Set the date your loss occurred',
            action: '/app/onboarding/index.html',
            completed: !!profile.claim?.lossDate
          },
          {
            id: 'description',
            label: 'Add Claim Description',
            description: 'Describe what happened in detail',
            action: '/app/onboarding/index.html',
            completed: !!profile.damage?.description
          },
          {
            id: 'photos',
            label: 'Upload Photos',
            description: 'Upload at least 5 evidence photos',
            action: '/app/evidence-organizer.html',
            completed: photoCount >= 5
          },
          {
            id: 'firstDocument',
            label: 'Generate First Document',
            description: 'Create your first claim document',
            action: '/app/document-generator-v2/document-generator.html',
            completed: docCount >= 1
          },
          {
            id: 'aiAgent',
            label: 'Use AI Response Agent',
            description: 'Try the AI Response Agent once',
            action: '/app/resource-center/ai-response-agent.html',
            completed: aiAgentUsed
          },
          {
            id: 'stage1',
            label: 'Complete Roadmap Stage 1',
            description: 'Finish the first stage of your claim roadmap',
            action: '/app/resource-center/claim-roadmap.html',
            completed: stage1Complete
          },
          {
            id: 'health',
            label: 'Achieve Claim Health 60+',
            description: 'Improve your claim health score to 60 or higher',
            action: '/app/resource-center.html',
            completed: health.score >= 60
          }
        ];

        // Calculate progress
        const completed = checklistItems.filter(item => item.completed).length;
        const total = checklistItems.length;
        const progress = Math.round((completed / total) * 100);

        // Update progress display
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${progress}% complete (${completed}/${total} items)`;

        // Render checklist
        const checklistContainer = document.getElementById('checklist-items');
        checklistContainer.innerHTML = checklistItems.map(item => `
          <div class="checklist-item ${item.completed ? 'completed' : ''}">
            <input 
              type="checkbox" 
              class="checklist-checkbox" 
              ${item.completed ? 'checked' : ''} 
              disabled
            >
            <div class="checklist-content">
              <div class="checklist-label">${item.label}</div>
              <div class="checklist-description">${item.description}</div>
            </div>
            ${!item.completed ? `
              <div class="checklist-action">
                <a href="${item.action}">Complete â†’</a>
              </div>
            ` : ''}
          </div>
        `).join('');

        // Save activation state
        const newActivation = {
          lossDate: checklistItems[0].completed,
          description: checklistItems[1].completed,
          photosUploaded: checklistItems[2].completed,
          firstDocument: checklistItems[3].completed,
          aiAgentUsed: checklistItems[4].completed,
          stage1Complete: checklistItems[5].completed,
          health60Plus: checklistItems[6].completed
        };

        // Update claim data
        const updatedClaimData = {
          ...activeClaim.claim_data,
          activation: newActivation
        };

        await supabase
          .from('claims')
          .update({ 
            claim_data: updatedClaimData,
            updated_at: new Date().toISOString()
          })
          .eq('id', activeClaim.id);

      } catch (error) {
        console.error('CNError (Activation):', error);
        if (window.CNToast) {
          window.CNToast.error('Failed to load activation checklist');
        }
      }
    })();
  </script>
</body>
</html>

