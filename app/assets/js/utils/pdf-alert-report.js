/**
 * PDF Alert Report Utility
 * Generates PDF reports for compliance alerts
 */

/**
 * Export alert report to PDF
 * @param {Object} alert - Alert object
 */
export async function exportAlertReport(alert) {
  try {
    if (!window.jspdf || !window.html2canvas) {
      // Load libraries if not available
      await loadPDFLibraries();
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 40;
    let yPosition = margin;

    // Title
    pdf.setFontSize(20);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Compliance Alert Report', margin, yPosition);
    yPosition += 30;

    // Alert Title
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text(alert.title || 'Compliance Alert', margin, yPosition);
    yPosition += 25;

    // Severity Badge
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold');
    const severityColor = alert.severity === 'high' ? [239, 68, 68] : alert.severity === 'medium' ? [245, 158, 11] : [59, 130, 246];
    pdf.setFillColor(...severityColor);
    pdf.rect(margin, yPosition - 10, 80, 15, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.text(alert.severity?.toUpperCase() || 'UNKNOWN', margin + 5, yPosition);
    pdf.setTextColor(0, 0, 0);
    yPosition += 25;

    // Date
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');
    const alertDate = new Date(alert.created_at || alert.timestamp || Date.now());
    pdf.text(`Date: ${alertDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, margin, yPosition);
    yPosition += 20;

    // Description
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Description:', margin, yPosition);
    yPosition += 15;
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(10);
    const descriptionLines = pdf.splitTextToSize(alert.description || 'No description available', pageWidth - 2 * margin);
    pdf.text(descriptionLines, margin, yPosition);
    yPosition += descriptionLines.length * 15 + 10;

    // Rule Violated
    if (alert.state_rule || alert.stateRule) {
      if (yPosition > pageHeight - 60) {
        pdf.addPage();
        yPosition = margin;
      }
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Rule Violated:', margin, yPosition);
      yPosition += 15;
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(10);
      const ruleLines = pdf.splitTextToSize(alert.state_rule || alert.stateRule || 'No specific rule identified', pageWidth - 2 * margin);
      pdf.text(ruleLines, margin, yPosition);
      yPosition += ruleLines.length * 15 + 10;
    }

    // Recommended Action
    if (alert.recommended_action || alert.recommendedAction) {
      if (yPosition > pageHeight - 60) {
        pdf.addPage();
        yPosition = margin;
      }
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Recommended Action:', margin, yPosition);
      yPosition += 15;
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(10);
      const actionLines = pdf.splitTextToSize(alert.recommended_action || alert.recommendedAction || 'No specific recommendation', pageWidth - 2 * margin);
      pdf.text(actionLines, margin, yPosition);
      yPosition += actionLines.length * 15 + 10;
    }

    // Related Timeline Event
    if (alert.related_timeline_event || alert.relatedTimelineEvent) {
      if (yPosition > pageHeight - 60) {
        pdf.addPage();
        yPosition = margin;
      }
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Related Timeline Event:', margin, yPosition);
      yPosition += 15;
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(10);
      pdf.text(alert.related_timeline_event || alert.relatedTimelineEvent, margin, yPosition);
      yPosition += 20;
    }

    // Category
    if (alert.category) {
      if (yPosition > pageHeight - 60) {
        pdf.addPage();
        yPosition = margin;
      }
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Category:', margin, yPosition);
      yPosition += 15;
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(10);
      pdf.text(alert.category, margin, yPosition);
      yPosition += 20;
    }

    // Footer
    const totalPages = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'italic');
      pdf.setTextColor(128, 128, 128);
      pdf.text(
        `Generated by Claim Navigator Compliance Engine - Page ${i} of ${totalPages}`,
        margin,
        pageHeight - 20
      );
      pdf.text(
        new Date().toLocaleString(),
        pageWidth - margin - 100,
        pageHeight - 20
      );
      pdf.setTextColor(0, 0, 0);
    }

    // Save PDF
    const filename = `compliance-alert-${alert.id || Date.now()}-${Date.now()}.pdf`;
    pdf.save(filename);

  } catch (error) {
    console.error('Error exporting alert PDF:', error);
    alert('Failed to export PDF: ' + error.message);
  }
}

/**
 * Load PDF libraries dynamically
 */
async function loadPDFLibraries() {
  return new Promise((resolve, reject) => {
    if (window.jspdf && window.html2canvas) {
      resolve();
      return;
    }

    const jspdfScriptId = 'jspdf-cdn-script';
    const html2canvasScriptId = 'html2canvas-cdn-script';

    let jspdfLoaded = !!window.jspdf;
    let html2canvasLoaded = !!window.html2canvas;

    if (!document.getElementById(jspdfScriptId)) {
      const jspdfScript = document.createElement('script');
      jspdfScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
      jspdfScript.defer = true;
      jspdfScript.id = jspdfScriptId;
      jspdfScript.onload = () => {
        jspdfLoaded = true;
        if (jspdfLoaded && html2canvasLoaded) resolve();
      };
      jspdfScript.onerror = reject;
      document.head.appendChild(jspdfScript);
    } else {
      jspdfLoaded = true;
    }

    if (!document.getElementById(html2canvasScriptId)) {
      const html2canvasScript = document.createElement('script');
      html2canvasScript.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
      html2canvasScript.defer = true;
      html2canvasScript.id = html2canvasScriptId;
      html2canvasScript.onload = () => {
        html2canvasLoaded = true;
        if (jspdfLoaded && html2canvasLoaded) resolve();
      };
      html2canvasScript.onerror = reject;
      document.head.appendChild(html2canvasScript);
    } else {
      html2canvasLoaded = true;
    }

    if (jspdfLoaded && html2canvasLoaded) {
      resolve();
    }
  });
}


