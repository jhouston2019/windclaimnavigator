/**
 * Document Branding Utility
 * 
 * Adds professional headers, footers, and watermarks to all claim documents.
 * Ensures consistent branding across all AI-generated outputs.
 */

/**
 * Apply branding to document HTML
 * 
 * @param {string} contentHtml - Raw HTML content
 * @param {Object} claimInfo - Claim context
 * @param {Object} metadata - Document metadata
 * @returns {string} Branded HTML with header, watermark, and footer
 */
export function applyDocumentBranding(contentHtml, claimInfo = {}, metadata = {}) {
  const brandedHtml = `
    <div class="claim-document-branded">
      ${generateDocumentHeader(claimInfo, metadata)}
      <div class="claim-document-body">
        ${generateWatermark()}
        ${contentHtml}
      </div>
      ${generateDocumentFooter(metadata)}
    </div>
  `;
  
  return brandedHtml;
}

/**
 * Generate document header block
 */
function generateDocumentHeader(claimInfo, metadata) {
  const insuredName = claimInfo.insuredName || 'N/A';
  const claimNumber = claimInfo.claimNumber || 'N/A';
  const carrier = claimInfo.carrier || 'N/A';
  const dateOfLoss = claimInfo.dateOfLoss 
    ? formatDate(claimInfo.dateOfLoss)
    : 'N/A';
  const generatedDate = formatDate(metadata.timestamp || new Date());

  return `
    <div class="claim-document-header">
      <div class="claim-document-logo">
        <h1>Claim Navigator</h1>
        <p class="claim-document-tagline">Professional Claim Documentation</p>
      </div>
      <div class="claim-document-info-grid">
        <div class="claim-document-info-row">
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Insured:</span>
            <span class="claim-document-info-value">${escapeHtml(insuredName)}</span>
          </div>
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Claim Number:</span>
            <span class="claim-document-info-value">${escapeHtml(claimNumber)}</span>
          </div>
        </div>
        <div class="claim-document-info-row">
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Insurance Carrier:</span>
            <span class="claim-document-info-value">${escapeHtml(carrier)}</span>
          </div>
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Date of Loss:</span>
            <span class="claim-document-info-value">${escapeHtml(dateOfLoss)}</span>
          </div>
        </div>
        <div class="claim-document-info-row">
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Document Generated:</span>
            <span class="claim-document-info-value">${generatedDate}</span>
          </div>
          ${metadata.toolName ? `
          <div class="claim-document-info-item">
            <span class="claim-document-info-label">Generated By:</span>
            <span class="claim-document-info-value">${escapeHtml(metadata.toolName)}</span>
          </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

/**
 * Generate watermark overlay
 */
function generateWatermark() {
  return `
    <div class="claim-document-watermark" aria-hidden="true">
      <span class="claim-document-watermark-text">
        CLAIM DOCUMENTATION â€” NOT LEGAL ADVICE
      </span>
    </div>
  `;
}

/**
 * Generate document footer
 */
function generateDocumentFooter(metadata) {
  const generatedDate = formatDate(metadata.timestamp || new Date());
  
  return `
    <div class="claim-document-footer">
      <div class="claim-document-footer-branding">
        <strong>Generated by Claim Navigator</strong>
        <span class="claim-document-footer-date">${generatedDate}</span>
      </div>
      <div class="claim-document-footer-disclaimer">
        <p>
          <strong>Important Notice:</strong> This document provides guidance and documentation 
          support based on the information you provide. It does not replace professional legal 
          or adjusting advice. Always consult with qualified professionals for legal matters 
          and complex claim issues.
        </p>
      </div>
      <div class="claim-document-footer-contact">
        <p>
          For questions or support, visit 
          <a href="https://claimnavigator.ai" target="_blank">claimnavigator.ai</a>
        </p>
      </div>
    </div>
  `;
}

/**
 * Inject branding styles into document
 */
export function injectBrandingStyles() {
  // Check if styles already injected
  if (document.getElementById('claim-branding-styles')) {
    return;
  }

  const styleEl = document.createElement('style');
  styleEl.id = 'claim-branding-styles';
  styleEl.textContent = `
    /* Document Branding Styles */
    .claim-document-branded {
      position: relative;
      background: white;
      padding: 2rem;
      max-width: 8.5in;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .claim-document-header {
      border-bottom: 3px solid #17BEBB;
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
    }

    .claim-document-logo h1 {
      margin: 0;
      font-size: 1.75rem;
      color: #2C3E50;
      font-weight: 700;
    }

    .claim-document-tagline {
      margin: 0.25rem 0 0 0;
      font-size: 0.875rem;
      color: #7F8C8D;
      font-style: italic;
    }

    .claim-document-info-grid {
      margin-top: 1rem;
    }

    .claim-document-info-row {
      display: flex;
      gap: 2rem;
      margin-bottom: 0.5rem;
    }

    .claim-document-info-item {
      flex: 1;
      display: flex;
      gap: 0.5rem;
    }

    .claim-document-info-label {
      font-weight: 600;
      color: #34495E;
      white-space: nowrap;
    }

    .claim-document-info-value {
      color: #2C3E50;
    }

    .claim-document-body {
      position: relative;
      min-height: 400px;
      padding: 1rem 0;
    }

    .claim-document-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 3rem;
      font-weight: 700;
      color: rgba(23, 190, 187, 0.08);
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      z-index: 0;
      letter-spacing: 0.1em;
    }

    .claim-document-body > *:not(.claim-document-watermark) {
      position: relative;
      z-index: 1;
    }

    .claim-document-footer {
      border-top: 2px solid #ECF0F1;
      padding-top: 1.5rem;
      margin-top: 2rem;
      font-size: 0.875rem;
      color: #7F8C8D;
    }

    .claim-document-footer-branding {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .claim-document-footer-branding strong {
      color: #2C3E50;
    }

    .claim-document-footer-date {
      color: #95A5A6;
    }

    .claim-document-footer-disclaimer {
      background: #FFF9E6;
      border-left: 4px solid #F39C12;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .claim-document-footer-disclaimer p {
      margin: 0;
      line-height: 1.6;
    }

    .claim-document-footer-contact {
      text-align: center;
    }

    .claim-document-footer-contact a {
      color: #17BEBB;
      text-decoration: none;
      font-weight: 600;
    }

    .claim-document-footer-contact a:hover {
      text-decoration: underline;
    }

    /* Print styles */
    @media print {
      .claim-document-branded {
        box-shadow: none;
        padding: 0;
      }

      .claim-document-watermark {
        color: rgba(23, 190, 187, 0.05);
      }
    }

    /* Output Standard Styles (from claim-output-standard.js) */
    .claim-output-document {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #2C3E50;
    }

    .claim-output-header {
      background: #F8F9FA;
      border: 1px solid #DEE2E6;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .claim-output-header-row {
      display: flex;
      gap: 2rem;
      margin-bottom: 0.5rem;
    }

    .claim-output-header-row:last-child {
      margin-bottom: 0;
    }

    .claim-output-header-col {
      flex: 1;
    }

    .claim-output-header-col strong {
      color: #495057;
      margin-right: 0.5rem;
    }

    .claim-output-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2C3E50;
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #17BEBB;
    }

    .claim-output-content {
      margin-bottom: 2rem;
    }

    .claim-output-letter p,
    .claim-output-analysis p,
    .claim-output-report p {
      margin-bottom: 1rem;
      line-height: 1.8;
    }

    .claim-checklist {
      list-style: none;
      padding: 0;
    }

    .claim-checklist li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #ECF0F1;
    }

    .claim-checklist li:last-child {
      border-bottom: none;
    }

    .claim-checklist input[type="checkbox"] {
      margin-right: 0.75rem;
    }

    .claim-output-footer {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #DEE2E6;
    }

    .claim-output-watermark {
      text-align: center;
      font-size: 0.75rem;
      color: #95A5A6;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
    }

    .claim-output-generator {
      text-align: center;
      font-size: 0.875rem;
      color: #6C757D;
      margin-bottom: 0.75rem;
    }

    .claim-output-disclaimer {
      background: #FFF9E6;
      border-left: 3px solid #F39C12;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: #856404;
      line-height: 1.6;
    }
  `;

  document.head.appendChild(styleEl);
}

/**
 * Format date consistently
 */
function formatDate(date) {
  if (!date) return 'N/A';
  
  const d = new Date(date);
  return d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

/**
 * Escape HTML
 */
function escapeHtml(text) {
  if (typeof text !== 'string') return text;
  
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Get claim info from current context
 * Attempts to retrieve from localStorage or form data
 */
export function getClaimInfoFromContext() {
  try {
    // Try localStorage first
    const storedClaim = localStorage.getItem('currentClaimInfo');
    if (storedClaim) {
      return JSON.parse(storedClaim);
    }

    // Try to extract from form on page
    const claimInfo = {};
    
    const insuredInput = document.querySelector('[name="insuredName"], [name="insured_name"], #insuredName');
    if (insuredInput) claimInfo.insuredName = insuredInput.value;
    
    const claimNumberInput = document.querySelector('[name="claimNumber"], [name="claim_number"], #claimNumber');
    if (claimNumberInput) claimInfo.claimNumber = claimNumberInput.value;
    
    const carrierInput = document.querySelector('[name="carrier"], [name="insurance_carrier"], #carrier');
    if (carrierInput) claimInfo.carrier = carrierInput.value;
    
    const dateOfLossInput = document.querySelector('[name="dateOfLoss"], [name="date_of_loss"], #dateOfLoss');
    if (dateOfLossInput) claimInfo.dateOfLoss = dateOfLossInput.value;

    return claimInfo;
  } catch (error) {
    console.warn('Could not retrieve claim info from context:', error);
    return {};
  }
}

/**
 * Save claim info to context for future use
 */
export function saveClaimInfoToContext(claimInfo) {
  try {
    localStorage.setItem('currentClaimInfo', JSON.stringify(claimInfo));
  } catch (error) {
    console.warn('Could not save claim info to context:', error);
  }
}


