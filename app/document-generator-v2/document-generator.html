<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Generator - ClaimNavigatorAI</title>
    
    <!-- CRITICAL: Access guard must load first -->
    <script src="/app/assets/js/supabase-client.js"></script>
    <script src="/app/assets/js/auth.js" type="module"></script>
    <script src="/app/assets/js/access-guard.js"></script>
    
    <link rel="stylesheet" href="/app/assets/css/style.css">
    <link rel="stylesheet" href="/app/assets/css/design-system.css">
    <link rel="stylesheet" href="/app/assets/css/document-generator.css">
    <link rel="stylesheet" href="/app/assets/css/resource-center.css">
    <link rel="stylesheet" href="/app/assets/css/tool-visual-alignment.css">
    <script src="/app/assets/js/auth-session.js"></script>
    <script src="/app/assets/js/paywall-enforcement.js"></script>
    <script src="/app/assets/js/analytics.js"></script>
    <script src="/app/assets/js/activation.js"></script>
    <script src="/app/assets/js/claim-profile.js"></script>
    <script src="/app/assets/js/document-spacing-fix.js"></script>
    <script src="/app/assets/js/document-watermark.js"></script>
    <script src="/storage/claimStorage.js"></script>
    <script src="/app/assets/js/compliance-banner.js"></script>
    <script>
      // Require authentication and check paywall
      (async () => {
        const isAuthenticated = await window.CNAuth?.requireAuth(true);
        if (!isAuthenticated) return;
        await window.checkPaywall?.();
      })();
    </script>
    
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="brand">Claim Navigation AI</div>
            <nav class="nav">
                <a href="/app/index.html">Home</a>
                <span>></span>
                <span>Document Generator</span>
                <span>></span>
                <a href="/app/resource-center.html">Resource Center</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div id="doc-generator-content-wrapper">
        <!-- Hero Section -->
        <div class="hero-section">
            <h2 class="hero-title">Professional Document Generator</h2>
            <p style="font-size:12px; color:#9ca3af; margin-bottom:12px; text-align:center; max-width:48rem; margin-left:auto; margin-right:auto;">
              Documents generated by Claim Navigator AI are templates and do not replace legal advice or professional representation.
              Review and modify all content before sending it to your insurer. For complex disputes, consult a licensed professional.
            </p>
            <p class="hero-subtitle">
                Generate professional insurance claim documents with AI assistance. Choose from core forms, letters & responses, financial worksheets, and specialized reports.
            </p>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-container">
            <!-- Search Bar -->
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search documents..." 
                class="search-bar"
            >
            
            <!-- Category Filter -->
                    <select id="categoryFilter" class="filter-dropdown">
                        <option value="">All Categories</option>
                        <option value="core-claim-documents">Core Claim Documents</option>
                        <option value="legal-documents">Legal Documents</option>
                        <option value="financial-documents">Financial Documents</option>
                        <option value="forms-&-requests">Forms & Requests</option>
                        <option value="appeals-&-disputes">Appeals & Disputes</option>
                        <option value="specialty-documents">Specialty Documents</option>
                        <option value="property-specific-documents">Property-Specific Documents</option>
                        <option value="business-specific-documents">Business-Specific Documents</option>
                        <option value="catastrophic-event-documents">Catastrophic Event Documents</option>
                    </select>
        </div>

        <!-- Documents Grid -->
        <div id="documentsContainer">
            <div class="loading">Loading documents...</div>
        </div>
    </main>

    <script>
        let allDocuments = [];
        let filteredDocuments = [];

        // Load documents from JSON
        async function loadDocuments() {
            try {
                const response = await fetch('./config/documents.json');
                if (!response.ok) throw new Error('Failed to load documents');
                allDocuments = await response.json();
                filteredDocuments = [...allDocuments];
                renderDocuments();
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsContainer').innerHTML = 
                    '<div class="error">Failed to load documents. Please try again later.</div>';
            }
        }

        // Render documents in grid
        function renderDocuments() {
            const container = document.getElementById('documentsContainer');
            
            if (filteredDocuments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No documents found matching your criteria.</div>';
                return;
            }

            // Sort documents alphabetically by title
            const sortedDocuments = [...filteredDocuments].sort((a, b) => a.title.localeCompare(b.title));

            const html = sortedDocuments.map(doc => `
                <div class="doc-card">
                    <div class="doc-card-content">
                        <div class="doc-title">${doc.title}</div>
                        <div class="doc-description">${doc.description}</div>
                        <div class="category-badge category-${doc.category.toLowerCase().replace(/\s+/g, '-')}">${doc.category}</div>
                    </div>
                    <div class="doc-card-footer">
                        <button class="generate-btn" onclick="generateDocument('${doc.id}')">
                            Generate â†’
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="doc-grid">${html}</div>`;
        }

        // Filter documents
        function filterDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredDocuments = allDocuments.filter(doc => {
                const matchesSearch = !searchTerm || 
                    doc.title.toLowerCase().includes(searchTerm) ||
                    doc.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || doc.category.toLowerCase().replace(/\s+/g, '-') === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });

            renderDocuments();
        }

        // Generate document
        function generateDocument(docId) {
            // Find the document details
            const doc = allDocuments.find(d => d.id === docId);
            if (!doc) {
                alert('Document not found');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'Opening...';
            button.disabled = true;
            
            // Mark activation milestone (first document generated)
            if (window.markActivation) {
                const activation = window.getActivation ? getActivation() : {};
                if (!activation["first_doc_generated"]) {
                    markActivation("first_doc_generated");
                }
            }
            
            // Redirect to form template with document ID
            setTimeout(() => {
                window.location.href = `/app/document-generator-v2/forms/form-template.html?id=${docId}`;
            }, 500);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterDocuments);
        document.getElementById('categoryFilter').addEventListener('change', filterDocuments);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDocuments();
            // Render compliance banner
            if (window.CNCompliance) {
                CNCompliance.renderBanner("doc-generator-content-wrapper");
            }
        });
    </script>
        </div> <!-- End doc-generator-content-wrapper -->
</body>
</html>