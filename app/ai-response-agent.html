<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Response Agent - Claim Navigator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/app/css/design-system.css">
    <link rel="stylesheet" href="/app/assets/css/tool-visual-alignment.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/app/assets/js/supabase-client.js"></script>
    <script src="/app/assets/js/auth-session.js"></script>
    <script src="/app/assets/js/paywall-enforcement.js"></script>
    <script src="/app/assets/js/analytics.js"></script>
    <script src="/app/assets/js/activation.js"></script>
    <script src="/app/assets/js/global.js"></script>
    <script src="/storage/claimStorage.js"></script>
    <script src="/app/assets/js/compliance-banner.js"></script>
    <script>
      // Require authentication and check paywall
      (async () => {
        const isAuthenticated = await window.CNAuth?.requireAuth(true);
        if (!isAuthenticated) return;
        await window.checkPaywall?.();
      })();
    </script>
</head>
<body class="ai-agent-page">
    <div id="ai-response-content-wrapper">
        <header class="ai-agent-hero">
            <div class="ai-agent-container">
                <div class="ai-agent-hero-content">
                    <p class="ai-agent-eyebrow">Core Tool</p>
                    <h1 class="ai-agent-hero-title">AI Response Agent</h1>
                    <p class="ai-agent-hero-subtitle">Upload insurer correspondence and generate the correct response instantly.</p>
                    <div class="ai-agent-hero-actions">
                        <a class="ai-agent-btn-primary" href="#ai-step-1">Start New Analysis</a>
                        <a class="ai-agent-btn-secondary" href="/app/resource-center.html">View Resources</a>
                    </div>
                    <p class="ai-agent-hero-note">Responses are informational and must be reviewed for your specific claim.</p>
                </div>
            </div>
        </header>

        <main class="ai-agent-main">
            <div class="ai-agent-container">
                <section class="ai-agent-section" id="ai-step-1">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 1</p>
                        <h2 class="ai-agent-section-title">Upload Insurer Letter</h2>
                        <p class="ai-agent-section-subtitle">Attach correspondence to kick off the analysis. Drag-and-drop or browse for a file.</p>
                    </div>
                    <div class="ai-agent-card">
                        <div class="ai-agent-upload-card">
                            <input type="file" id="documentUpload" accept=".pdf,.doc,.docx,.txt" class="ai-agent-file-input">
                            <div id="uploadArea" class="ai-agent-upload-area">
                                <div class="ai-agent-upload-icon">üìÑ</div>
                                <div>
                                    <p class="ai-agent-upload-title">Drag & drop your insurer letter</p>
                                    <p class="ai-agent-upload-meta">PDF, DOC, DOCX, or TXT files supported</p>
                                </div>
                            </div>
                            <div id="fileInfo" class="ai-agent-file-info hidden">
                                <div class="ai-agent-file-row">
                                    <span class="ai-agent-file-status">‚úÖ</span>
                                    <span id="fileName" class="ai-agent-file-name"></span>
                                    <button id="removeFile" class="ai-agent-link-button" type="button">Remove</button>
                                </div>
                            </div>
                            <p class="ai-agent-helper">Optional: paste the text instead in Step 2 if you cannot upload the file.</p>
                            <div class="ai-agent-validation">Validation messages will appear here.</div>
                        </div>
                        <div id="userInfoDisplay" class="ai-agent-inline-card">
                            <div class="ai-agent-inline-card-header">
                                <p class="ai-agent-step-label muted">Claim Profile</p>
                                <span class="ai-agent-chip">Auto-loaded</span>
                            </div>
                            <div id="userInfoContent" class="ai-agent-info-grid">
                                <p class="ai-agent-helper">Loading your information from intake forms...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-2">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 2</p>
                        <h2 class="ai-agent-section-title">Describe Your Situation</h2>
                        <p class="ai-agent-section-subtitle">Share context to help the AI tailor its analysis and response.</p>
                    </div>
                    <div class="ai-agent-card ai-agent-stack">
                        <div class="ai-agent-field">
                            <label for="insurerLetter">Insurer correspondence (Optional, max 500 chars)</label>
                            <textarea id="insurerLetter" rows="6" class="ai-agent-input" maxlength="500" placeholder="Paste key excerpts from insurer correspondence (optional if file uploaded)..."></textarea>
                        </div>
                        <div class="ai-agent-guides">
                            <p class="ai-agent-guides-title">Guiding prompts</p>
                            <ul class="ai-agent-guides-list">
                                <li>What was the insurer decision or request?</li>
                                <li>Key deadlines or response windows noted?</li>
                                <li>Coverage details or damages in dispute?</li>
                            </ul>
                        </div>
                        <div class="ai-agent-field">
                            <label for="responseMode">Response style</label>
                            <select id="responseMode" class="ai-agent-input">
                                <option value="reply">Standard Reply</option>
                                <option value="appeal">Professional Appeal</option>
                                <option value="clarify">Policy Clarification</option>
                                <option value="negotiate">Negotiation Strategy</option>
                                <option value="summary">Summary & Guidance</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-3">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 3</p>
                        <h2 class="ai-agent-section-title">AI Analysis Engine</h2>
                        <p class="ai-agent-section-subtitle">Coverage interpretation, claim posture, and adjuster behavior insights.</p>
                    </div>
                    <div class="ai-agent-card ai-agent-grid ai-agent-grid-three">
                        <div class="ai-agent-subcard">
                            <h3>Coverage Interpretation</h3>
                            <p class="ai-agent-helper">How your policy language applies to this letter.</p>
                            <div class="ai-agent-pill-list">
                                <span class="ai-agent-pill">Exclusions review</span>
                                <span class="ai-agent-pill">Limits & sub-limits</span>
                                <span class="ai-agent-pill">Deductible impact</span>
                            </div>
                        </div>
                        <div class="ai-agent-subcard">
                            <h3>Claim Posture</h3>
                            <p class="ai-agent-helper">AI posture on liability, valuation, and next best move.</p>
                            <ul class="ai-agent-bullet-list">
                                <li>Position: Pending determination</li>
                                <li>Confidence: Awaiting analysis</li>
                                <li>Negotiation leverage: In review</li>
                            </ul>
                        </div>
                        <div class="ai-agent-subcard">
                            <h3>Risk Flags & Adjuster Signals</h3>
                            <p class="ai-agent-helper">Identify tactics, delays, and statutory triggers.</p>
                            <ul class="ai-agent-bullet-list">
                                <li>Response timelines</li>
                                <li>Documentation gaps</li>
                                <li>Behavioral indicators</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-4">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 4</p>
                        <h2 class="ai-agent-section-title">Recommended Responses</h2>
                        <p class="ai-agent-section-subtitle">Immediate actions and tailored reply options based on your inputs.</p>
                    </div>
                    <div class="ai-agent-card ai-agent-stack">
                        <div class="ai-agent-divided">
                            <div>
                                <p class="ai-agent-divided-title">Key actions</p>
                                <ul class="ai-agent-divided-list">
                                    <li>Confirm coverage references cited by the adjuster.</li>
                                    <li>List evidence that supports your loss facts.</li>
                                    <li>Note any statutory response deadlines.</li>
                                    <li>Clarify outstanding requests or documentation.</li>
                                </ul>
                            </div>
                            <div>
                                <p class="ai-agent-divided-title">Response focus</p>
                                <ul class="ai-agent-divided-list">
                                    <li>Address each insurer assertion with facts.</li>
                                    <li>Restate policy language that favors the claim.</li>
                                    <li>Set expectations for follow-up and timelines.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="ai-agent-actions">
                            <button id="analyzeBtn" type="button" class="ai-agent-btn-primary ai-agent-btn-lg">
                                <span id="analyzeText">Generate Full Response Letter</span>
                                <span id="analyzingText" class="hidden">Analyzing...</span>
                            </button>
                            <button id="clearBtn" type="button" class="ai-agent-btn-secondary ai-agent-btn-lg">Clear Fields</button>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-5">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 5</p>
                        <h2 class="ai-agent-section-title">Draft Email Response</h2>
                        <p class="ai-agent-section-subtitle">Review, copy, and export the AI-generated correspondence.</p>
                    </div>
                    <div class="ai-agent-card ai-agent-stack">
                        <div id="aiOutput" class="ai-agent-output">
                            <div id="placeholder" class="ai-agent-placeholder">
                                <div class="ai-agent-placeholder-icon">ü§ñ</div>
                                <p>Click ‚ÄúGenerate Full Response Letter‚Äù to produce your draft email.</p>
                            </div>
                            <div id="loadingIndicator" class="ai-agent-loading hidden">
                                <div class="ai-agent-spinner"></div>
                                <p>AI is analyzing your correspondence...</p>
                            </div>
                            <div id="aiResponse" class="hidden"></div>
                        </div>
                        <div class="ai-agent-actions">
                            <button id="copyBtn" type="button" class="ai-agent-btn-secondary ai-agent-btn-lg">Copy to Clipboard</button>
                            <button id="exportBtn" type="button" class="ai-agent-btn-primary ai-agent-btn-lg">Export to PDF</button>
                        </div>
                        <div id="aiInsights" class="hidden ai-agent-inline-card">
                            <div class="ai-agent-inline-card-header">
                                <p class="ai-agent-divided-title">AI Detected Issues</p>
                            </div>
                            <ul id="issuesList" class="ai-agent-divided-list"></ul>
                        </div>
                        <div id="aiSuggestions" class="hidden ai-agent-inline-card">
                            <div class="ai-agent-inline-card-header">
                                <p class="ai-agent-divided-title">Suggested Actions</p>
                            </div>
                            <ul id="suggestionsList" class="ai-agent-divided-list"></ul>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-6">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 6</p>
                        <h2 class="ai-agent-section-title">Supporting Documents</h2>
                        <p class="ai-agent-section-subtitle">Organize documentation that strengthens your position.</p>
                    </div>
                    <div class="ai-agent-grid ai-agent-grid-three">
                        <div class="ai-agent-card">
                            <h3 class="ai-agent-card-title">Recommended Documents</h3>
                            <p class="ai-agent-helper">Policy excerpts, declarations, and endorsements.</p>
                        </div>
                        <div class="ai-agent-card">
                            <h3 class="ai-agent-card-title">Proof of Loss</h3>
                            <p class="ai-agent-helper">Signed forms, estimates, and valuations to validate amounts.</p>
                        </div>
                        <div class="ai-agent-card">
                            <h3 class="ai-agent-card-title">Claim Journal Entries</h3>
                            <p class="ai-agent-helper">Date-stamped communications and adjuster interactions.</p>
                        </div>
                        <div class="ai-agent-card">
                            <h3 class="ai-agent-card-title">Evidence Attachments</h3>
                            <p class="ai-agent-helper">Photos, receipts, expert reports, and contractor notes.</p>
                        </div>
                    </div>
                </section>

                <section class="ai-agent-section" id="ai-step-7">
                    <div class="ai-agent-section-header">
                        <p class="ai-agent-step-label">Step 7</p>
                        <h2 class="ai-agent-section-title">Sync to Claim Tools</h2>
                        <p class="ai-agent-section-subtitle">Push insights and responses into your claim workspace.</p>
                    </div>
                    <div class="ai-agent-grid ai-agent-grid-three">
                        <div class="ai-agent-card ai-agent-mini-card">
                            <h3 class="ai-agent-card-title">Add to Claim Journal</h3>
                            <p class="ai-agent-helper">Log this interaction for audit-ready history.</p>
                        </div>
                        <div class="ai-agent-card ai-agent-mini-card">
                            <h3 class="ai-agent-card-title">Add to Evidence Organizer</h3>
                            <p class="ai-agent-helper">Attach correspondence alongside exhibits.</p>
                        </div>
                        <div class="ai-agent-card ai-agent-mini-card">
                            <h3 class="ai-agent-card-title">Add to Timeline</h3>
                            <p class="ai-agent-helper">Track milestones and statutory deadlines.</p>
                        </div>
                        <div class="ai-agent-card ai-agent-mini-card">
                            <h3 class="ai-agent-card-title">Trigger Deadline Scan</h3>
                            <p class="ai-agent-helper">Surface response windows and reminders.</p>
                        </div>
                        <div class="ai-agent-card ai-agent-mini-card">
                            <h3 class="ai-agent-card-title">Trigger Coverage Review</h3>
                            <p class="ai-agent-helper">Run coverage checks against state-specific rules.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const analyzeBtn = document.getElementById('analyzeBtn');
        const copyBtn = document.getElementById('copyBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const responseMode = document.getElementById('responseMode');
        const insurerLetter = document.getElementById('insurerLetter');
        const aiOutput = document.getElementById('aiOutput');
        const placeholder = document.getElementById('placeholder');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const aiResponse = document.getElementById('aiResponse');
        const aiInsights = document.getElementById('aiInsights');
        const aiSuggestions = document.getElementById('aiSuggestions');
        const issuesList = document.getElementById('issuesList');
        const suggestionsList = document.getElementById('suggestionsList');
        const analyzeText = document.getElementById('analyzeText');
        const analyzingText = document.getElementById('analyzingText');
        
        // Document upload elements
        const documentUpload = document.getElementById('documentUpload');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const userInfoContent = document.getElementById('userInfoContent');
        
        // Global variables
        let uploadedFile = null;
        let userData = null;

        // Auto-populate user data from intake forms
        function loadUserData() {
            // Try to get user data from localStorage or sessionStorage
            const savedUserData = localStorage.getItem('claimNavigatorUserData') || sessionStorage.getItem('claimNavigatorUserData');
            
            if (savedUserData) {
                try {
                    userData = JSON.parse(savedUserData);
                    displayUserInfo(userData);
                } catch (e) {
                    console.log('Error parsing user data:', e);
                    displayDefaultUserInfo();
                }
            } else {
                // Try to get from URL parameters or other sources
                const urlParams = new URLSearchParams(window.location.search);
                const name = urlParams.get('name');
                const email = urlParams.get('email');
                
                if (name || email) {
                    userData = {
                        name: name || 'Not provided',
                        email: email || 'Not provided',
                        policyNumber: 'Auto-populated',
                        claimNumber: 'Auto-populated',
                        dateOfLoss: 'Auto-populated',
                        company: 'Auto-populated',
                        phone: 'Auto-populated',
                        address: 'Auto-populated'
                    };
                    displayUserInfo(userData);
                } else {
                    displayDefaultUserInfo();
                }
            }
        }

        function displayUserInfo(data) {
            const infoHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div><strong>Name:</strong> ${data.name || 'Not provided'}</div>
                    <div><strong>Email:</strong> ${data.email || 'Not provided'}</div>
                    <div><strong>Policy:</strong> ${data.policyNumber || 'Not provided'}</div>
                    <div><strong>Claim:</strong> ${data.claimNumber || 'Not provided'}</div>
                    <div><strong>Company:</strong> ${data.company || 'Not provided'}</div>
                    <div><strong>Phone:</strong> ${data.phone || 'Not provided'}</div>
                </div>
            `;
            userInfoContent.innerHTML = infoHtml;
        }

        function displayDefaultUserInfo() {
            userInfoContent.innerHTML = `
                <p class="italic">No user information found. Please complete the intake forms first.</p>
                <a href="/app/register.html" class="text-blue-600 text-sm underline">Complete Intake Forms ‚Üí</a>
            `;
        }

        // Document upload functionality
        function setupDocumentUpload() {
            // Click to upload
            uploadArea.addEventListener('click', () => {
                documentUpload.click();
            });

            // File selection
            documentUpload.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: files } });
                }
            });

            // Remove file
            removeFile.addEventListener('click', () => {
                uploadedFile = null;
                documentUpload.value = '';
                fileInfo.classList.add('hidden');
                uploadArea.classList.remove('hidden');
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadedFile = file;
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                
                // Extract text from file if possible
                extractTextFromFile(file);
            }
        }

        function extractTextFromFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                
                // For text files, populate the textarea
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    insurerLetter.value = content;
                } else {
                    // For other files, show a message
                    insurerLetter.value = `[Document uploaded: ${file.name}]\n\nPlease paste the text content below or the AI will analyze the file directly.`;
                }
            };
            
            if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                reader.readAsText(file);
            } else {
                // For PDF/DOC files, we'll need to handle them on the backend
                console.log('File uploaded, will be processed by backend:', file.name);
            }
        }

        // Analyze button click handler
        analyzeBtn.addEventListener('click', async () => {
            const letter = insurerLetter.value.trim();
            const mode = responseMode.value;

            // Validation
            if (!letter && !uploadedFile) {
                alert('Please upload a document or paste the insurer letter for analysis.');
                return;
            }
            
            // Lowball/Denial Detection
            if (letter && window.detectLowballOrDenial) {
                if (detectLowballOrDenial(letter)) {
                    localStorage.setItem("cn_lowball_detected", "1");
                    if (window.CNAnalytics) {
                        CNAnalytics.log("event_lowball_detected", { source: "ai_response_agent" });
                    }
                    
                    // Trigger real-time Claim Health recalculation
                    if (window.CNHealthHooks) {
                        window.CNHealthHooks.trigger();
                    }
                }
            }
            
            // Mark activation
            if (window.markActivation) {
                markActivation("ai_agent_used");
            }
            
            // Log timeline event
            if (window.CNTimeline) {
                window.CNTimeline.log("ai_response", {});
            }

            // Show loading state
            analyzeBtn.disabled = true;
            analyzeText.classList.add('hidden');
            analyzingText.classList.remove('hidden');
            placeholder.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            aiResponse.classList.add('hidden');
            aiInsights.classList.add('hidden');
            aiSuggestions.classList.add('hidden');

            try {
                // Prepare form data for file upload
                const formData = new FormData();
                formData.append('mode', mode);
                // Include claim profile if available
                const claimProfile = (window.CNClaimProfile) ? CNClaimProfile.getClaimProfile() || {} : {};
                
                // Add state module information for state-aware AI prompts
                let stateInfo = null;
                if (window.CNClaimProfile && window.CNStateModules) {
                  const stateCode = window.CNClaimProfile.getClaimStateCode(claimProfile);
                  const stateModule = window.CNStateModules.get(stateCode);
                  stateInfo = {
                    code: stateModule.code,
                    name: stateModule.name,
                    statutes: stateModule.regulations.statutes || []
                  };
                }
                
                const claimData = { 
                  ...(userData || {}), 
                  claimProfile,
                  stateInfo: stateInfo
                };
                formData.append('claim', JSON.stringify(claimData));
                formData.append('letter', letter);
                
                if (uploadedFile) {
                    formData.append('document', uploadedFile);
                }

                const response = await fetch('/.netlify/functions/aiResponseAgent', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Check if response is streaming
                const contentType = response.headers.get('content-type');
                let data = null;
                
                if (contentType && (contentType.includes('text/stream') || contentType.includes('text/event-stream'))) {
                    // Handle streaming response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedText = '';
                    
                    loadingIndicator.classList.add('hidden');
                    aiResponse.classList.remove('hidden');
                    aiResponse.innerHTML = `<div class="fade-in"><h4 class="font-semibold mb-3">üìù Draft Response Letter</h4><div class="text-gray-800 whitespace-pre-wrap" id="streaming-content"></div></div>`;
                    const streamingContent = document.getElementById('streaming-content');
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        accumulatedText += chunk;
                        streamingContent.textContent = accumulatedText;
                    }
                    
                    // Try to parse accumulated text as JSON for issues/suggestions
                    try {
                        data = JSON.parse(accumulatedText);
                    } catch (e) {
                        data = { draftLetter: accumulatedText, analysis: accumulatedText };
                    }
                } else {
                    // Handle regular JSON response
                    data = await response.json();

                    // Hide loading, show results
                    loadingIndicator.classList.add('hidden');
                    aiResponse.classList.remove('hidden');
                    aiResponse.innerHTML = `<div class="fade-in"><h4 class="font-semibold mb-3">üìù Draft Response Letter</h4><div class="text-gray-800 whitespace-pre-wrap">${data.draftLetter || data.analysis || ''}</div></div>`;
                }

                // Show detected issues
                if (data && data.issues && data.issues.length > 0) {
                    aiInsights.classList.remove('hidden');
                    issuesList.innerHTML = data.issues.map(issue => `<li><span class="text-red-500 mr-2">‚ö†Ô∏è</span><span>${issue}</span></li>`).join('');
                }

                // Show suggestions
                if (data && data.suggestions && data.suggestions.length > 0) {
                    aiSuggestions.classList.remove('hidden');
                    suggestionsList.innerHTML = data.suggestions.map(suggestion => `<li><span class="text-green-500 mr-2">‚úì</span><span>${suggestion}</span></li>`).join('');
                }

            } catch (error) {
                console.error('Error:', error);
                loadingIndicator.classList.add('hidden');
                aiResponse.classList.remove('hidden');
                aiResponse.innerHTML = `<div class="text-red-600 p-4 bg-red-50 rounded-md"><strong>Error:</strong> ${error.message}. Please try again.</div>`;
            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeText.classList.remove('hidden');
                analyzingText.classList.add('hidden');
            }
        });

        // Copy to clipboard functionality
        copyBtn.addEventListener('click', () => {
            const text = aiResponse.textContent.trim();
            if (!text) {
                alert('Please generate an analysis first before copying.');
                return;
            }
            const copyAction = navigator.clipboard?.writeText
                ? navigator.clipboard.writeText(text)
                : Promise.resolve().then(() => {
                    const temp = document.createElement('textarea');
                    temp.value = text;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                });
            copyAction.then(() => {
                alert('Draft copied to clipboard.');
            }).catch(() => {
                alert('Unable to copy. Please try manually.');
            });
        });

        // Export PDF functionality
        exportBtn.addEventListener('click', async () => {
            if (!aiResponse.textContent.trim()) {
                alert('Please generate an analysis first before exporting.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Claim Navigator - AI Response Analysis', 20, 20);
                
                // Claim Information
                const claimData = collectFormData();
                doc.setFontSize(12);
                let yPos = 40;
                doc.text('Claim Information:', 20, yPos);
                yPos += 10;
                
                Object.entries(claimData).forEach(([key, value]) => {
                    if (value) {
                        doc.text(`${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`, 20, yPos);
                        yPos += 7;
                    }
                });
                
                yPos += 10;
                doc.text('AI Analysis:', 20, yPos);
                yPos += 10;
                
                // AI Response
                const responseText = aiResponse.textContent;
                const splitText = doc.splitTextToSize(responseText, 170);
                doc.text(splitText, 20, yPos);
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text('Claim Navigator - AI Response & Analysis Agent', 20, doc.internal.pageSize.height - 10);
                }
                
                doc.save('claim-analysis.pdf');
            } catch (error) {
                console.error('PDF export error:', error);
                alert('Error generating PDF. Please try again.');
            }
        });

        // Clear fields functionality
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all fields?')) {
                insurerLetter.value = '';
                uploadedFile = null;
                documentUpload.value = '';
                fileInfo.classList.add('hidden');
                uploadArea.classList.remove('hidden');
                placeholder.classList.remove('hidden');
                aiResponse.classList.add('hidden');
                aiInsights.classList.add('hidden');
                aiSuggestions.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
            }
        });

        // Auto-save functionality (optional)
        function autoSave() {
            const formData = {
                mode: responseMode.value,
                letter: insurerLetter.value
            };
            localStorage.setItem('claimNavigatorData', JSON.stringify(formData));
        }

        // Load saved data
        function loadSavedData() {
            const saved = localStorage.getItem('claimNavigatorData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    responseMode.value = data.mode || 'reply';
                    insurerLetter.value = data.letter || '';
                } catch (e) {
                    console.log('No saved data found');
                }
            }
        }

        // Initialize the application
        function initializeApp() {
            loadUserData();
            setupDocumentUpload();
            loadSavedData();
        }

        // Event listeners for auto-save
        responseMode.addEventListener('change', autoSave);
        insurerLetter.addEventListener('input', autoSave);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            // Render compliance banner
            if (window.CNCompliance) {
                CNCompliance.renderBanner("ai-response-content-wrapper");
            }
        });
    </script>
    <script src="/app/assets/js/claim-profile.js"></script>
    <script src="/app/assets/js/state-modules.js"></script>
    <script src="/app/assets/js/health-hooks.js"></script>
    <script type="module" src="/app/assets/js/tools/ai-response-agent.js"></script>
</body>
</html>