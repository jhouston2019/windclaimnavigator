<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affiliate Dashboard â€“ Navigator</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="p-4">
    <h1 class="text-xl font-bold">Navigator Affiliate Dashboard</h1>
  </header>

  <main class="max-w-4xl mx-auto p-6">
    <!-- Login / Signup -->
    <div id="auth-section" class="space-y-4">
      <h2 class="text-2xl font-semibold">Affiliate Login / Signup</h2>
      <input id="email" type="email" placeholder="Email"
        class="border p-2 w-full rounded"/>
      <input id="password" type="password" placeholder="Password"
        class="border p-2 w-full rounded"/>
      <div class="flex gap-4">
        <button onclick="signUp()" class="px-4 py-2 bg-blue-600  rounded">Sign Up</button>
        <button onclick="signIn()" class="px-4 py-2 bg-green-600  rounded">Sign In</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden space-y-6">
      <h2 class="text-2xl font-semibold">Welcome, <span id="user-email"></span></h2>

      <div class="p-4 border rounded  shadow">
        <p>
          Your Referral Link: 
          <span id="referral-link" class="font-mono"></span>
          <button onclick="copyReferral()" class="ml-2 px-2 py-1 bg-blue-500  rounded">Copy</button>
        </p>
      </div>

      <div class="grid grid-cols-3 gap-4">
        <div class="p-4 border rounded ">
          <p class="text-sm ">Total Sales</p>
          <p id="total-sales" class="text-xl font-bold">0</p>
        </div>
        <div class="p-4 border rounded ">
          <p class="text-sm ">Pending Commissions</p>
          <p id="pending-commissions" class="text-xl font-bold">$0</p>
        </div>
        <div class="p-4 border rounded ">
          <p class="text-sm ">Lifetime Commissions</p>
          <p id="lifetime-commissions" class="text-xl font-bold">$0</p>
        </div>
      </div>

      <button onclick="connectStripe()" class="px-4 py-2 bg-purple-600  rounded">
        Connect Stripe Account
      </button>
    </div>
  </main>

  <script>
    const supabase = supabase.createClient(
      "{{ SUPABASE_URL }}",
      "{{ SUPABASE_ANON_KEY }}"
    );

    let currentUser = null;
    let affiliate = null;

    async function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      currentUser = data.user;
      initDashboard();
    }

    async function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      currentUser = data.user;
      initDashboard();
    }

    async function initDashboard() {
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("user-email").innerText = currentUser.email;

      // fetch affiliate profile
      const { data, error } = await supabase
        .from("affiliates")
        .select("*")
        .eq("email", currentUser.email)
        .single();

      if (!error && data) {
        affiliate = data;
      } else {
        // create profile if not exists
        const referralCode = crypto.randomUUID().slice(0, 8);
        const { data: newAff } = await supabase
          .from("affiliates")
          .insert([{ email: currentUser.email, referral_code: referralCode }])
          .select()
          .single();
        affiliate = newAff;
      }

      const link = `${window.location.origin}/?ref=${affiliate.referral_code}`;
      document.getElementById("referral-link").innerText = link;

      fetchTransactions();
    }

    async function fetchTransactions() {
      const { data, error } = await supabase
        .from("transactions")
        .select("*")
        .eq("affiliateid", affiliate.id);

      if (error) return console.error(error);

      document.getElementById("total-sales").innerText = data.length;
      const pending = data
        .filter(t => t.payout_status === "pending")
        .reduce((sum, t) => sum + t.amount * affiliate.commission_rate, 0);
      const lifetime = data
        .reduce((sum, t) => sum + t.amount * affiliate.commission_rate, 0);

      document.getElementById("pending-commissions").innerText = `$${pending}`;
      document.getElementById("lifetime-commissions").innerText = `$${lifetime}`;
    }

    function copyReferral() {
      const text = document.getElementById("referral-link").innerText;
      navigator.clipboard.writeText(text);
      alert("Referral link copied!");
    }

    function connectStripe() {
      window.location.href = "/connect-stripe"; // TODO: add your Stripe onboarding link
    }
  </script>
<script type="module" src="/app/assets/js/diagnostics.js"></script>
<script type="module" src="/app/assets/js/window-bridge.js"></script>
</body>
</html>
